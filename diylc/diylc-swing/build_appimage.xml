<project name="diylc-swing" basedir="." default="appimage">

	<taskdef name="bundleapp"
	             classname="com.oracle.appbundler.AppBundlerTask"  />

	<import file="download_jre.xml" />
	<import file="build.xml" />

	<property name="appdir" value="${build.dir}/AppDir" />
	<property name="appimagetool" value="${basedir}/tools/appimagetool-x86_64.AppImage" />

	<target name="appimage" depends="jar, fetch-jre-linux">

		<!-- Ensure clean AppDir -->
		<delete dir="${appdir}" />
		<mkdir dir="${appdir}/usr/bin" />
		<mkdir dir="${appdir}/usr/share/icons/hicolor/512x512/apps" />

		<!-- Copy app files -->
		<zipfileset dir="${jar.dir}" includes="diylc.jar" />
		<zipfileset dir="${jar.dir}/lib" prefix="lib" />
		<zipfileset dir="${jar.dir}/library/" prefix="library" />
		<zipfileset dir="templates" prefix="templates" />
		<zipfileset dir="themes" prefix="themes" />
		<zipfileset dir="fonts" prefix="fonts" />
		<zipfileset dir="lang" prefix="lang" />
		<zipfileset dir="deploy" includes="splash.png" />

		<copy file="${jar.dir}/diylc.jar" todir="${appdir}/usr/diylc" />
		<copy todir="${appdir}/usr/diylc/lib">
			<fileset dir="${jar.dir}/lib">
				<include name="*"/>
			</fileset>
		</copy>
		<copy todir="${appdir}/usr/bin/library">
			<fileset dir="${jar.dir}/library">
				<include name="*"/>
			</fileset>
		</copy>
		<copy todir="${appdir}/usr/bin/templates">
			<fileset dir="${jar.dir}/templates">
				<include name="*"/>
			</fileset>
		</copy>
		<copy todir="${appdir}/usr/bin/themes">
			<fileset dir="${jar.dir}/themes">
				<include name="*"/>
			</fileset>
		</copy>
		<copy todir="${appdir}/usr/bin/fonts">
			<fileset dir="${jar.dir}/fonts">
				<include name="*"/>
			</fileset>
		</copy>
		<copy todir="${appdir}/usr/bin/lang">
			<fileset dir="${jar.dir}/lang">
				<include name="*"/>
			</fileset>
		</copy>
		<copy file="appimage/diylc.sh" tofile="${appdir}/usr/bin/diylc" />
		<copy file="deploy/splash.png" todir="${appdir}/usr/bin" />
		<chmod file="${appdir}/usr/bin/diylc" perm="755" />

		<!-- Copy icons and desktop file -->
		<copy file="icons/icon_512x512.png" tofile="${appdir}/usr/share/icons/hicolor/512x512/apps/com.diy_fever.DIYLayoutCreator.png" />
		<copy file="appimage/com.diy_fever.DIYLayoutCreator.desktop" todir="${appdir}/usr/share/applications" />

		<!-- Download appimagetool if not present -->
		<mkdir dir="${basedir}/tools" />
		<get src="https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
			 dest="${appimagetool}"
			 usetimestamp="true" />
		<chmod file="${appimagetool}" perm="755" />

		<!-- Create AppImage -->
		<exec executable="${appimagetool}" dir="${appdir}/..">
			<arg value="AppDir" />
			<arg value="DIYLayoutCreator-${version}-x86_64.AppImage" />
		</exec>

		<echo message="AppImage built: DIYLayoutCreator-${diylc.version}-x86_64.AppImage" />
	</target>
</project>
